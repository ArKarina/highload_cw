# highload_cw

## Содержание

* [Тема и целевая аудитория](#1)
* [Расчет нагрузки](#2)
* [Глобальная балансировка нагрузки](#3)
* [Локальная балансировка нагрузки](#4)
* [Логическая схема БД](#5)
* [Схема проекта](#6)
* [Источники](#8)


## 1. Тема и целевая аудитория <a name="1"></a>

**Zoom** — это приложение для проведения онлайн видеоконференций и вебинаров в формате высокой еткости, предназначенное для использования в бизнесе. Он был основан в 2011 году Эриком Юанем и запущен в январе 2013 года.

### Аналоги

- Skype
- Discord
- Google Meet

### MVP

- Создание видеоконференций
- Приглашение на видеоконференцию
- Проведение видеоконференций
- Чат
- Запись видеоконференций (локально и облачно)

### Целевая аудитория

[Источник](https://nutmegeducation.com/zoom-user-statistics)
показывает, что Zoom имеет 12.92 миллиона активных пользователей в месяц и 10 миллионов активных пользователей в неделю. Так же сообщается, что среднее число сессий Zoom за день составляет 350 миллионов человек. Однако, это значение не отражает количество уникальных пользователей в день. Большинство людей проводят несколько конференций за день и параллельно могут учавствовать в нескольких конференциях. Будем считать, что количество активных пользователей в день составляет 9 миллионов. Платформой пользуются около 470 000 платящих бизнес-клиентов.

Трафик, генерируемый Zoom в разных странах, составляет: 
![Image alt](https://github.com/ArKarina/highload_cw/raw/main/img/countries.png)


При этом статистика активности во время видеоконференций выглядит следующим образом.
![Image alt](https://github.com/ArKarina/highload_cw/raw/main/img/Webinar.png)

## 2. Расчет нагрузки <a name="2"></a>

### Продуктовые метрики

- Месячная аулитория - 12.92 миллиона человек
- Дневная аудитория - 9 миллионов человек
- Средний размер хранилища пользователя - [5 Гб](https://support.zoom.us/hc/en-us/articles/360060661511-Cloud-recording-storage-capacity)
- Среднее количество действий пользователя по типам в день
  1. Создание видеоконференций.
     По данным CNBC 2021, большинство людей проводят 9 или 10 видеоконференций в день. Возьмем среднее число конференций за 5.
  2. Приглашение на видеоконференцию.
     После того как пользователь создаст видеоконференцию, пусть он для каждой создаст еще и ссылку. Тогда их тоже будет 5.
  3. Проведение видеоконференций.
     При условии, что средняя продолжительность конференций варьируется [от 31 до 60 минут](https://teamstage.io/zoom-statistics/) (выберем среднее 45) и пользователь проводит 5 конференций в день, средняя продолжительность конференций пользователя за день составляет 45 * 5 = 225 минут.
  4. Отправка сообщений в чат.
     В среднем пользователь отправляет 5 сообщений за конференцию. Тогда 5 * 5 = 25 сообщений в день
  5. Записи видеоконференций.
     В среднем пользователь сохраняет 5 записей в месяц, что составляет 5/30 = 0.16 сохранений в день
     
**Итоговая таблица**

| Создание конференций | Приглашение на видеоконференцию | Проведение видеоконференций | Отправка сообщений в чат | Записи видеоконференций |
|---------------------------|----------------------|-----------------------|-----------------------|------------------------|
| 5                         | 5                  | 225 минут                  | 25                  | 0.16                    |


### Технические метрики

**Размер хранения**

Расчеты будем проводить для одного месяца.

Ранее указывалось, что платформой пользуются около 470 000 платящих бизнес-клиентов. Тогда

- Хранилище платного пользователя (с учетом записей конференций) = 470 000 * 5Гб = 2295 Тб
- Хранилище пользователя = 12 450 000 * 1 Мб = 11.9 Тб
- Записи чатов = 12 920 000 * 5 * 30 *  25 000 * 8б * = 353 ТБ
(Считаем, что за день проводится 5 конференций, чат конференции содержит в среднем 25000 символов (4250 слов). Символы кодируются utf-8, 1 символ занимает 8 байт.)
- Хранилище звонков = 12 920 000 * 2 * 35б * 30 = 25 Гб

**Сетевой трафик**

По [данным Zoom](https://support.zoom.us/hc/ru/articles/201362023-%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-Zoom-%D0%B4%D0%BB%D1%8F-%D0%9E%D0%A1-Windows-macOS-%D0%B8-Linux#:~:text=%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20%D0%BA%20%D0%BF%D1%80%D0%BE%D0%BF%D1%83%D1%81%D0%BA%D0%BD%D0%BE%D0%B9%20%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8,-Zoom%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B8%D1%80%D1%83%D0%B5%D1%82%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5&text=%D0%94%D0%BB%D1%8F%20%D0%B2%D0%B8%D0%B4%D0%B5%D0%BE%D0%B2%D1%8B%D0%B7%D0%BE%D0%B2%D0%BE%D0%B2%201%20%D0%BD%D0%B0%201,%2F%D1%81%20(%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B0%D1%8F%2F%D0%B2%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B0%D1%8F)%3B) пропускная способность для HD видео должна быть 1.8 МБит/с на загрузку, FULL HD - 3 МБит/с. Тогда средняя пропускная способность будет равна 2.4 Мбит/с на пользователя.

Конференция в среднем длится 45 минут. Пользователь в среднем использует видеокамеру 60% времени, а аудио - 30% времени.
Пропускная способность на пользователя = 2.4 * 2700 = 6480 Мбит/час = 6.33 ГБит/час

Для всех пользователей = 6.33 * 9 000 000 * 0.6 = 34 182 000 ГБит/ч

Передача аудио = 16 Кбит/с * 9 000 000 * 2700 * 0.3 = 116640 Гбит/ч

Сохранение записи в облаке

По [данным Zoom](https://support.zoom.us/hc/ru/articles/201362023-%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-Zoom-%D0%B4%D0%BB%D1%8F-%D0%9E%D0%A1-Windows-macOS-%D0%B8-Linux#:~:text=%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20%D0%BA%20%D0%BF%D1%80%D0%BE%D0%BF%D1%83%D1%81%D0%BA%D0%BD%D0%BE%D0%B9%20%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8,-Zoom%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B8%D1%80%D1%83%D0%B5%D1%82%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5&text=%D0%94%D0%BB%D1%8F%20%D0%B2%D0%B8%D0%B4%D0%B5%D0%BE%D0%B2%D1%8B%D0%B7%D0%BE%D0%B2%D0%BE%D0%B2%201%20%D0%BD%D0%B0%201,%2F%D1%81%20(%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B0%D1%8F%2F%D0%B2%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B0%D1%8F)%3B) скорость выгрузки для HD видео должна быть не менее 1.2 МБ/с.

Для всех пользователей: 1.25 Мбит/с * 9 000 000 * 0.16 = 1800 Гбит/ч 

**Сетевой трафик при пике нагрузки**

Пусть в пиковый час нагрузка составляет 30% от дневной нагрузки, т.е. 2.7 миллиона человек, звук и видео используются 60% и 80% времени соответственно.

Пиковая нагрузка = 6.33 * 2 700 000 * 0.8 + 16 Кбит/с * 10^-6 * 2 700 000 * 2700 * 0.6 + 1.25 Мбит/с * 10^-3 * 2 700 000 * 0.16 = 13 743 324 ГБит/ч = 3818 ГБит/с

**RPS в разбивке по типам запросов**

- Создание, удаление конференции и генерация прглашения: 9 000 000 * 5 * 3 / 24 / 60 / 60 = 1562.5 rps
- Участие в конференции: 9 000 000 * 5 * 2 * 2 / 24 / 60 / 60 = 2083.3 rps
- Сохранение видеозаписи: 9 000 000 * 0.16 / 24 / 60 / 60 = 16.7 rps
- Отправка сообщений в чат: 9 000 000 * 25 / 24 / 60 / 60 = 2604 rps

Суммарно: 6266.5 RPS


## 3. Глобальная балансировка нагрузки <a name="3"></a>

### Глобальная балансировка

Балансировка между датацентрами будет осуществляться по принципу DNS. Будем распределять нагрузку равномерно на балансировщики с помощью Latency-based DNS.

### Физическое расположение датацентров

С начала 2011 года Zoom построила географически распределенные центры обработки данных по всему миру. Они используют сеть частных каналов для подключения множества других. Пользователи могут подключиться к дата-центру, ближайшему к их местоположению. Они обслуживают видеоконференции в реальном времени в своих центрах обработки данных или внутри корпоративных сетей.

По статистике 49% пользователей Zoom находятся в США, следовательно, в Северной Америке нужно размемтить самое большое количество датацентров. Второе по величение количество датацентров следует разместить в странах азии. Так же датацентры нужно разместить в Европе, Австралии и Южной Америке.

Физическое расположение датацентров:
![Image alt](https://github.com/ArKarina/highload_cw/raw/main/img/zoom-distributed.jpg)


## 4. Локальная балансировка нагрузки <a name="4"></a>

1. Перед граничными маршрутизаторами в центрах обработки данных разместим CDN(Content Delivery Network), который поддерживает "прогретые" соединения. Это поможет сократить задержки для клиентов и улучшить производительность Zoom.

2. Для обеспечения отказоустойчивости зарезервируем второй маршрутизатор с использованием протокола VRRP(Virtual Router Redundancy Protocol). Это обеспечит автоматическое переключение на резервный маршрутизатор в случае сбоя.

3. Развернем многоуровневую балансировку трафика. Это может включать балансировку на уровне граничных маршрутизаторов, коммутаторов и слой L7 балансировщиков.

4. На каждом балансировщике используем многопоточные сетевые карты с поддержкой MSI-X(Multiple-Queue Interrupt) для эффективного распределения нагрузки между CPU.

5. Используем ECMP(Equal-Cost Multi-Path) с поддержкой per-flow балансировки для "закрепления" одной TCP-сессии за одним сервером. Добавим соль в хэш для устранения поляризации в ECMP.

6. В роли L7 балансировщиков используем ingress controller-ы кластера Kubernetes. Разместим контроллеры на отдельных нодах для обеспечения безопасности, доступности и отказоустойчивости.

7. В качестве балансировщика на уровне приложения используем Envoy, который предоставляет дополнительные возможности маршрутизации и контроля трафика.

8. Внедрим механизмы liveness и readiness проб для автоматического обнаружения неработающих серверов и переключения трафика на доступные экземпляры.

9. Реализуем балансировку трафика в зависимости от субдоменов и URL-префиксов для обеспечения функциональной балансировки.

10. Внедрим механизмы контроля скорости (Rate Limiting) для управления нагрузкой на сервера и предотвращения перегрузок.

11. Выполним SSL-терминирование на балансировщиках с оптимизацией, такой как session cache и session tickets, для улучшения производительности.

12. Внутри кластера Zoom, реализуем балансировку нагрузки между экземплярами приложения в рамках одного replicaset, чтобы обеспечить равномерное распределение нагрузки.

13. Для обеспечения отказоустойчивости используем протокол VRRP или аналогичные для резервирования балансировщиков.

14. Развернем механизмы автоматического обнаружения сервисов(Service Discovery) для динамической настройки балансировщиков в зависимости от изменений в инфраструктуре.

## 5. Логическая схема БД <a name="5"></a>

## 6. Схема проекта <a name="6"></a>

## 8. Источники <a name="8"></a>

1. https://www.statista.com/statistics/1259905/zoom-website-traffic/
2. https://www.prosperityforamerica.org/zoom-statistics/
3. https://nutmegeducation.com/zoom-user-statistics
4. https://support.zoom.us/hc/en-us/articles/360060661511-Cloud-recording-storage-capacity
5. https://teamstage.io/zoom-statistics/
